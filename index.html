<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Rock Paper Scissors</title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body class="flex-column">
    <header class="container padding-1">
      <h1>Rock Paper Scissors</h1>
    </header>
    <main class="container padding-1 flex-column">
      <form>
        <input
          class="padding-1"
          type="number"
          placeholder="Enter round number"
          required
        />
        <button class="padding-1" type="submit">Start game</button>
      </form>
    </main>
    <footer class="container padding-1">
      <a href="https://www.sarpisik.com/">Sarp ISIK</a>
    </footer>
    <script>
      /*

        selectionsList: array of selections to render button for each.
        selectionIndexes: used to calculate winner / loser on round.
        resultIndexes: an object contains score.
        roundCountLimit: defines the round limit.
        roundCount: shows the current round.
        player, computer: numeric indexes to use in conditional functions.

        DOM
        container: a container parent div.
        form: form element.
        selectionsList: contains user selection value.

      */
      let selectionsList = ['rock', 'paper', 'scissors'],
        selectionIndexes = {
          rock: 0,
          paper: 1,
          scissors: 2
        },
        player = '1',
        computer = '2',
        resultIndexes = { [player]: 0, [computer]: 0 },
        roundCountLimit,
        roundCount = 0,
        container,
        buttonsContainer,
        form,
        resultText,
        playerSelection,
        win = 'Win',
        lose = 'Lose',
        tie = 'Tie'

      // Init the game
      window.addEventListener('load', render)

      function render() {
        form = document.querySelector('form')
        //Modern browsers
        form.addEventListener('submit', handleSubmit)
      }
      function handleSubmit(e) {
        e.preventDefault()
        roundCountLimit = Number(document.querySelector('input').value)
        if (roundCountLimit > 0) {
          container = document.querySelector('main.container')
          // Remove input form
          container.removeChild(form)
          resultText = document.createElement('p')
          // Create intro text on DOM
          const p = document.createElement('p')
          p.innerText = `Lets beat the machine! Hell Yeah! Make a choice!
        Paper, Scissors or Rock!`
          container.appendChild(p)
          container.appendChild(resultText)
          buttonsContainer = document.createElement('div')
          buttonsContainer.setAttribute('class', 'buttons-container')
          // Create buttons of selections on DOM
          renderSelections()
        } else {
          alert('Please enter a positive integer')
        }
      }

      function renderSelections() {
        selectionsList.forEach(function(name) {
          const button = document.createElement('button')
          button.innerText = toFirstLetterUpperCase(name)
          setAttributes(button, {
            type: 'submit',
            name,
            class: 'padding-1'
          })
          button.addEventListener('click', handleSelection)
          buttonsContainer.appendChild(button)
        })
        container.appendChild(buttonsContainer)
      }

      function handleSelection(e) {
        e.preventDefault()
        resultText.innerText = ''
        playerSelection = e.target.name
        handleRound(playerSelection, function() {
          // If this is final round check score
          if (roundCount >= roundCountLimit) {
            const result = Object.keys(resultIndexes).filter(setResult)

            // If both players has equal score, run one more round.
            // Else, finish the game.
            if (result.length > 1) {
              roundCountLimit++
              alert('It is a tie! Go one more round!')
            } else {
              // Use conditions to define how the game has ended.
              displayResult(result[0])
            }
          }
        })
      }

      // Run on every round
      function handleRound(playerSelection, callBack) {
        const playerSelectionText = playerSelection.toLowerCase(),
          computerSelection = computerPlay(),
          result = playRound(playerSelectionText, computerSelection)
        if (result) {
          resultText.innerText = result
          callBack()
        } else {
          restartRound('It is a tie! Try again.')
        }
      }

      // Computer's selection
      function computerPlay() {
        const randomIndex = Math.random()
        if (randomIndex < 1 / 3) return 'rock'
        if (randomIndex < 2 / 3) return 'paper'
        return 'scissors'
      }

      function restartRound(text) {
        resultText.innerText = text
      }

      function playRound(playerSelection, computerSelection) {
        switch (
          selectionIndexes[playerSelection] -
            selectionIndexes[computerSelection]
        ) {
          // Combinations for player wins
          case -2:
            return setRoundScore(player, playerSelection, computerSelection)
            break
          case 1:
            return setRoundScore(player, playerSelection, computerSelection)
            break

          // Combinations for computer wins
          case -1:
            return setRoundScore(computer, playerSelection, computerSelection)
            break
          case 2:
            return setRoundScore(computer, playerSelection, computerSelection)
            break

          // Tie up, restart the round
          default:
            return false
            break
        }
      }

      function setRoundScore(roundWinner, ...rest) {
        // Update score & round count
        roundCount++
        resultIndexes[roundWinner] += 1
        // Set current round's score message
        return roundMessage(roundWinner, ...rest)
      }

      function roundMessage(roundWinner, ...rest) {
        // Array of player's and computer's selections
        const selections = rest

        // Upper case the first letters of selections.
        const playerSelectionUpperCase = toFirstLetterUpperCase(selections[0])
        const computerSelectionUpperCase = toFirstLetterUpperCase(selections[1])

        // The winner of the round is player
        if (roundWinner === player)
          return roundText(
            win,
            playerSelectionUpperCase,
            computerSelectionUpperCase
          )

        // The winner of the round is computer
        return roundText(
          lose,
          computerSelectionUpperCase,
          playerSelectionUpperCase
        )
      }

      function roundText(result, selectionWinner, selectionLoser) {
        const scoreText = getScoreText()

        return `You ${result} on round (${roundCount}) ! ${selectionWinner} beats ${selectionLoser} ! ${scoreText}`
      }

      // Return the key which has max value in the score object
      function setResult(key) {
        return resultIndexes[key] >= roundCountLimit / 2
      }

      // Print the final of the game.
      function displayResult(resultIndex) {
        const body = document.body
        if (resultIndex === player) {
          return (body.innerText = `
          Congratulations !
          You ${win} !
          ${getScoreText()}`)
        }
        return (body.innerText = `
        Game Over !
        You ${lose} !
        ${getScoreText()}`)
      }

      // Helper functions
      function setAttributes(el, attrs) {
        for (var key in attrs) {
          el.setAttribute(key, attrs[key])
        }
      }
      function getScoreText() {
        return `The score is: You (${resultIndexes[player]}) - Computer (${
          resultIndexes[computer]
        })`
      }
      function toFirstLetterUpperCase(str) {
        return str.charAt(0).toUpperCase() + str.slice(1)
      }
    </script>
  </body>
</html>
